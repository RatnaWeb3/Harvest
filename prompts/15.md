# Prompt 15: End-to-End Testing and Bug Fixes

## Objective
Perform comprehensive end-to-end testing of the entire Harvest application and fix any bugs discovered.

## Pre-Flight Checklist
- [ ] Read ALL `docs/issues/*/README.md` files for known issues
- [ ] Ensure all previous prompts (1-14) completed
- [ ] Have test wallet with positions on Movement
- [ ] Backend and frontend both running

## Context
Before production deployment, we need to:
1. Test all user flows end-to-end
2. Fix any discovered bugs
3. Document any new issues found
4. Ensure error handling works correctly

## Tasks

### 1. Test Environment Setup
Ensure you have:
- Movement testnet/mainnet wallet with test positions
- Backend running with database
- Frontend running with correct environment variables
- Browser dev tools open for debugging

### 2. User Flow Testing Checklist

#### A. Wallet Connection Flow
```
[ ] Connect wallet via Privy - should open Privy modal
[ ] Select wallet type - should connect successfully
[ ] Wallet address displays in header
[ ] Disconnect works correctly
[ ] Reconnect remembers previous session
```

**If issues found:**
- Document in `docs/issues/movement/README.md`
- Fix immediately if critical

#### B. Dashboard Loading Flow
```
[ ] Dashboard loads without errors
[ ] Loading skeleton appears while fetching
[ ] Portfolio summary shows correct totals
[ ] Each protocol's positions load
[ ] Positions with no data show empty state (not mock)
[ ] Total value calculates correctly
[ ] 24h earnings calculate correctly
[ ] Error states show meaningful messages
```

**If issues found:**
- Document in `docs/issues/ui/README.md`
- Fix data fetching issues immediately

#### C. Rewards Display Flow
```
[ ] Pending rewards load for each protocol
[ ] Rewards show correct token symbols
[ ] USD values calculate correctly
[ ] "Claim All" total matches sum of individual rewards
[ ] Rewards refresh when requested
[ ] Empty rewards shows "No pending rewards"
```

#### D. Single Protocol Claim Flow
```
[ ] Click "Claim" on single reward
[ ] Transaction modal appears
[ ] Wallet popup shows correct transaction
[ ] Approve transaction
[ ] Pending state shows correctly
[ ] Transaction confirms on chain
[ ] Success modal with explorer link
[ ] Rewards refresh after claim
[ ] Claim recorded to backend
[ ] Leaderboard updates
```

**Test error cases:**
```
[ ] User rejects transaction - handled gracefully
[ ] Network error - shows error message
[ ] Insufficient gas - shows clear error
```

#### E. Batch Claim Flow
```
[ ] Click "Claim All"
[ ] Selection modal shows all protocols
[ ] Can select/deselect protocols
[ ] Total updates based on selection
[ ] Execute batch claim
[ ] Transaction builds correctly
[ ] All selected rewards claimed
[ ] Individual failures don't break batch
```

#### F. Auto-Compound Flow
```
[ ] Navigate to Rewards > Compound tab
[ ] Strategies load with APY
[ ] Quote calculates correctly
[ ] Swap path shows if needed
[ ] Execute compound
[ ] Transaction succeeds
[ ] Position created in target protocol
```

#### G. Airdrop Tracker Flow
```
[ ] Airdrops page loads
[ ] Filters work (upcoming, live, claimable, ended)
[ ] Search works
[ ] Check eligibility works
[ ] Eligibility result displays correctly
[ ] Set reminder works
[ ] Reminder notification triggers (test with short delay)
```

#### H. Leaderboard Flow
```
[ ] Leaderboard loads from API
[ ] Period selector changes data
[ ] User's rank displays correctly
[ ] Ranks update after claiming
[ ] Share rank works
```

#### I. Settings Flow
```
[ ] Settings page loads
[ ] Telegram ID saves correctly
[ ] Discord webhook saves correctly
[ ] Notifications trigger correctly
```

### 3. Error Handling Testing

Test each error scenario:

```typescript
// Simulate errors by temporarily breaking things:

// 1. Network errors
// Disconnect internet, try to load dashboard
[ ] Shows "Network error" message
[ ] Retry button works

// 2. RPC errors
// Use invalid RPC URL temporarily
[ ] Shows "Failed to connect to Movement" message

// 3. Indexer errors
// Use invalid indexer URL
[ ] Falls back gracefully (empty positions, not crash)

// 4. Backend errors
// Stop backend server
[ ] Leaderboard shows cached data or error
[ ] Claims still work (blockchain only)
```

### 4. Performance Testing

```
[ ] Dashboard loads in < 3 seconds
[ ] Position data refreshes in < 2 seconds
[ ] Transaction submission responds quickly
[ ] No memory leaks (check browser dev tools)
[ ] No excessive re-renders (React DevTools)
```

### 5. Mobile Responsiveness Testing

```
[ ] Dashboard readable on mobile
[ ] Navigation works on mobile
[ ] Modals fit on mobile screens
[ ] Touch interactions work
[ ] Tables scroll horizontally
```

### 6. Fix Discovered Bugs

For each bug found:

1. **Document the issue** in appropriate `docs/issues/*/README.md`:
```markdown
## UI-001: Dashboard crashes when wallet has no positions

**Problem:** TypeError when positions array is undefined

**Root Cause:** Missing null check in positions-table.tsx

**Solution:** Add optional chaining and fallback to empty array

**Prevention:** Always check for undefined arrays in components
```

2. **Fix the bug** with minimal changes
3. **Test the fix** thoroughly
4. **Update tests** if applicable

### 7. Create Bug Fix Summary

After testing, create a summary:

**docs/testing/e2e-results.md**:
```markdown
# E2E Testing Results - [Date]

## Test Summary
- Total Flows Tested: X
- Passed: X
- Failed: X
- Fixed: X

## Issues Found and Fixed

### Critical
1. [Bug description] - Fixed in [file]

### Medium
1. [Bug description] - Fixed in [file]

### Low
1. [Bug description] - Fixed in [file]

## Known Limitations
1. [Limitation] - [Reason/Workaround]

## Recommendations
1. [Improvement suggestion]
```

### 8. Regression Testing

After fixes, re-run all test flows to ensure fixes don't break other features.

## Deliverables
- [ ] All user flows tested
- [ ] All discovered bugs documented
- [ ] Critical and medium bugs fixed
- [ ] `docs/testing/e2e-results.md` created
- [ ] No regression issues

## Verification
```bash
# Run frontend build to catch TypeScript errors
cd frontend && yarn build

# Run backend to ensure no crashes
cd backend && npm run dev

# Manual testing of all flows
# Document any issues in docs/issues/
```

## Testing Environment
- Browser: Chrome (latest)
- Mobile: Chrome DevTools mobile simulation
- Network: Movement mainnet or testnet
- Backend: Local with PostgreSQL and Redis

## Notes
- Document ALL issues, even minor ones
- Fix critical bugs immediately
- Low priority bugs can be tracked for later
- Take screenshots of issues for documentation
- Test with multiple wallet types if possible
