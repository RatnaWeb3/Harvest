# Prompt 6: Add Thunderhead Liquid Staking Integration

## Objective
Integrate Thunderhead liquid staking protocol to track stMOVE positions and staking rewards.

## Pre-Flight Checklist
- [ ] Read `docs/issues/move/README.md` for any Move issues
- [ ] Read `docs/protocol-research.md` for Thunderhead addresses
- [ ] Ensure Prompts 1-5 completed
- [ ] Load skill: `move-dev`

## Context
Thunderhead is the liquid staking protocol on Movement. Users stake MOVE and receive stMOVE. Staking rewards accrue automatically in the stMOVE exchange rate.

## Tasks

### 1. Create Thunderhead Configuration
**frontend/constants/protocols/thunderhead.ts**:

```typescript
const THUNDERHEAD_MODULE_ADDRESS =
  process.env.NEXT_PUBLIC_THUNDERHEAD_ADDRESS || '0x...'

export const THUNDERHEAD_CONFIG = {
  moduleAddress: THUNDERHEAD_MODULE_ADDRESS,
  displayName: 'Thunderhead',
  color: '#6366F1', // Indigo
  icon: 'thunderhead',

  // stMOVE token address
  stMoveAddress: `${THUNDERHEAD_MODULE_ADDRESS}::stmove::StMOVE`,

  viewFunctions: {
    getStakeBalance: `${THUNDERHEAD_MODULE_ADDRESS}::staking::get_balance`,
    getExchangeRate: `${THUNDERHEAD_MODULE_ADDRESS}::staking::exchange_rate`,
    getPendingRewards: `${THUNDERHEAD_MODULE_ADDRESS}::staking::pending_rewards`,
  },

  entryFunctions: {
    stake: `${THUNDERHEAD_MODULE_ADDRESS}::staking::stake`,
    unstake: `${THUNDERHEAD_MODULE_ADDRESS}::staking::unstake`,
    claimRewards: `${THUNDERHEAD_MODULE_ADDRESS}::staking::claim`,
  },
} as const

export const isThunderheadDeployed = (): boolean => {
  return THUNDERHEAD_MODULE_ADDRESS !== '0x...'
}
```

### 2. Create Thunderhead Service
**frontend/lib/services/thunderhead-service.ts**:

```typescript
import { aptos, TransactionPayload } from '@/lib/move'
import {
  ProtocolService,
  Position,
  RewardItem,
  ProtocolId,
} from './protocol-interface'
import { THUNDERHEAD_CONFIG, isThunderheadDeployed } from '@/constants/protocols/thunderhead'

class ThunderheadService implements ProtocolService {
  readonly protocolId: ProtocolId = 'thunderhead'
  readonly displayName = 'Thunderhead'

  async getPositions(address: string): Promise<Position[]> {
    if (!isThunderheadDeployed()) {
      return []
    }

    try {
      // Get stMOVE balance
      const balance = await this.getStMoveBalance(address)
      if (balance === 0n) return []

      // Get exchange rate to calculate underlying MOVE
      const exchangeRate = await this.getExchangeRate()
      const underlyingMove = (balance * exchangeRate) / BigInt(1e18)

      // Get current APY
      const apy = await this.getCurrentAPY()

      return [{
        id: 'thunderhead-stmove',
        protocolId: 'thunderhead',
        type: 'staking',
        tokenSymbol: 'stMOVE',
        tokenAddress: THUNDERHEAD_CONFIG.stMoveAddress,
        amount: formatUnits(balance, 8),
        valueUsd: await this.calculateValueUsd(underlyingMove),
        apy,
        metadata: {
          underlyingMove: formatUnits(underlyingMove, 8),
          exchangeRate: formatUnits(exchangeRate, 18),
        },
      }]
    } catch (error) {
      console.error('[Thunderhead] Error fetching positions:', error)
      return []
    }
  }

  async getPendingRewards(address: string): Promise<RewardItem[]> {
    if (!isThunderheadDeployed()) {
      return []
    }

    try {
      const result = await aptos.view({
        payload: {
          function: THUNDERHEAD_CONFIG.viewFunctions.getPendingRewards,
          typeArguments: [],
          functionArguments: [address],
        },
      })

      const pendingAmount = BigInt(result[0] as string)
      if (pendingAmount === 0n) return []

      return [{
        id: 'thunderhead-reward',
        protocolId: 'thunderhead',
        positionId: 'thunderhead-stmove',
        tokenSymbol: 'MOVE',
        tokenAddress: NATIVE_MOVE_ADDRESS,
        amount: formatUnits(pendingAmount, 8),
        valueUsd: await this.calculateValueUsd(pendingAmount),
        claimable: true,
      }]
    } catch (error) {
      console.error('[Thunderhead] Error fetching rewards:', error)
      return []
    }
  }

  async buildClaimTransaction(address: string): Promise<TransactionPayload> {
    return {
      function: THUNDERHEAD_CONFIG.entryFunctions.claimRewards,
      typeArguments: [],
      functionArguments: [],
    }
  }

  private async getStMoveBalance(address: string): Promise<bigint> {
    const result = await aptos.view({
      payload: {
        function: THUNDERHEAD_CONFIG.viewFunctions.getStakeBalance,
        typeArguments: [],
        functionArguments: [address],
      },
    })
    return BigInt(result[0] as string)
  }

  private async getExchangeRate(): Promise<bigint> {
    const result = await aptos.view({
      payload: {
        function: THUNDERHEAD_CONFIG.viewFunctions.getExchangeRate,
        typeArguments: [],
        functionArguments: [],
      },
    })
    return BigInt(result[0] as string)
  }

  private async getCurrentAPY(): Promise<number> {
    // Calculate from exchange rate change or fetch from API
    return 18.5 // Placeholder - implement real calculation
  }

  private async calculateValueUsd(amount: bigint): Promise<number> {
    const movePrice = await getMovePrice()
    return Number(formatUnits(amount, 8)) * movePrice
  }
}

export const thunderheadService = new ThunderheadService()
```

### 3. Create Thunderhead Position Card
**frontend/components/protocols/thunderhead/thunderhead-position-card.tsx**:

```typescript
import { Card } from '@/components/ui/card'
import { Position } from '@/lib/services/protocol-interface'
import { TokenDisplay } from '@/components/shared/token-display'
import { ProtocolBadge } from '@/components/shared/protocol-badge'

interface ThunderheadPositionCardProps {
  position: Position
}

export function ThunderheadPositionCard({ position }: ThunderheadPositionCardProps) {
  return (
    <Card className="p-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <ProtocolBadge protocolId="thunderhead" />
          <div>
            <p className="font-medium">Liquid Staking</p>
            <p className="text-sm text-muted-foreground">
              {position.metadata?.underlyingMove} MOVE staked
            </p>
          </div>
        </div>

        <div className="text-right">
          <TokenDisplay
            amount={position.amount}
            symbol="stMOVE"
            usdValue={position.valueUsd}
          />
          <p className="text-sm text-green-500">{position.apy}% APY</p>
        </div>
      </div>

      <div className="mt-3 text-xs text-muted-foreground">
        Exchange Rate: 1 stMOVE = {position.metadata?.exchangeRate} MOVE
      </div>
    </Card>
  )
}
```

### 4. Register Service
**frontend/lib/services/protocol-registry.ts**:

```typescript
import { thunderheadService } from './thunderhead-service'

export const protocolRegistry: Record<ProtocolId, ProtocolService> = {
  yuzu: yuzuService,
  joule: jouleService,
  meridian: meridianService,
  thunderhead: thunderheadService, // Add this
}
```

### 5. Add to Protocol Constants Index
**frontend/constants/protocols/index.ts**:

```typescript
import { THUNDERHEAD_CONFIG } from './thunderhead'

export const PROTOCOL_CONFIGS = {
  yuzu: YUZU_CONFIG,
  joule: JOULE_CONFIG,
  meridian: MERIDIAN_CONFIG,
  thunderhead: THUNDERHEAD_CONFIG, // Add this
}

export const ACTIVE_PROTOCOLS: ProtocolId[] = [
  'yuzu',
  'joule',
  'meridian',
  'thunderhead', // Add this
]
```

### 6. Add Protocol Adapter (Move)
**contracts/sources/harvest/adapters/thunderhead_adapter.move**:

```move
module harvest::thunderhead_adapter {
    use std::signer;

    const THUNDERHEAD_ADDRESS: address = @thunderhead;

    public fun claim(user: &signer): bool {
        // Call Thunderhead's claim function
        // thunderhead::staking::claim(user);
        true // Placeholder until integrated
    }
}
```

## Deliverables
- [ ] Created `frontend/constants/protocols/thunderhead.ts`
- [ ] Created `frontend/lib/services/thunderhead-service.ts`
- [ ] Created `frontend/components/protocols/thunderhead/thunderhead-position-card.tsx`
- [ ] Registered service in protocol registry
- [ ] Added to active protocols list
- [ ] Created Move adapter (can be placeholder)

## Verification
```bash
# Frontend compiles
cd frontend && yarn build

# Service registered correctly
yarn dev
# Connect wallet with stMOVE
# Verify position appears in dashboard
```

## Testing
- [ ] stMOVE balance displays correctly
- [ ] Underlying MOVE value calculated correctly
- [ ] APY displays correctly
- [ ] Claim button works (if rewards claimable)
- [ ] Position appears in portfolio summary

## Notes
- Thunderhead may have auto-compounding (no manual claim needed)
- Check if rewards are separate or baked into exchange rate
- Keep service under 200 lines
- Use consistent error handling pattern
