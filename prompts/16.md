# Prompt 16: Production Deployment

## Objective
Deploy the complete Harvest application to production with proper infrastructure, monitoring, and security.

## Pre-Flight Checklist
- [ ] Read `docs/issues/tooling/README.md` for any deployment issues
- [ ] Ensure Prompt 15 completed (all tests passing)
- [ ] Have production accounts ready (Vercel, database host, etc.)
- [ ] Domain name configured

## Context
Deploy the complete stack:
- Frontend → Vercel
- Backend → Railway/Render/Fly.io
- Database → Supabase/Neon/PlanetScale
- Redis → Upstash
- Move Contracts → Movement Mainnet

## Tasks

### 1. Prepare Environment Variables

**Frontend (.env.production)**:
```env
NEXT_PUBLIC_MOVEMENT_RPC_URL=https://mainnet.movementnetwork.xyz/v1
NEXT_PUBLIC_MOVEMENT_CHAIN_ID=126
NEXT_PUBLIC_API_URL=https://api.harvest.app
NEXT_PUBLIC_INDEXER_URL=https://indexer.movementnetwork.xyz/v1/graphql

# Privy
NEXT_PUBLIC_PRIVY_APP_ID=your_privy_app_id

# Protocol Addresses (from Prompt 1 research)
NEXT_PUBLIC_YUZU_ADDRESS=0x...
NEXT_PUBLIC_JOULE_ADDRESS=0x...
NEXT_PUBLIC_MERIDIAN_ADDRESS=0x...
NEXT_PUBLIC_THUNDERHEAD_ADDRESS=0x...
NEXT_PUBLIC_HARVEST_ADDRESS=0x...

# Analytics (optional)
NEXT_PUBLIC_POSTHOG_KEY=your_posthog_key
```

**Backend (.env.production)**:
```env
NODE_ENV=production
PORT=4000

# Database (Supabase/Neon)
DATABASE_URL=postgresql://user:password@host:5432/harvest

# Redis (Upstash)
REDIS_URL=redis://default:password@host:6379

# Movement RPC
MOVEMENT_RPC_URL=https://mainnet.movementnetwork.xyz/v1

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token

# Cors
FRONTEND_URL=https://harvest.app

# Secrets
JWT_SECRET=your_jwt_secret
```

### 2. Deploy Database

**Using Supabase:**
```bash
# Create project at supabase.com
# Get connection string

# Run migrations
psql $DATABASE_URL < backend/migrations/001_initial.sql
psql $DATABASE_URL < backend/migrations/002_airdrops.sql

# Seed initial data
psql $DATABASE_URL < backend/seeds/airdrops.sql
```

**Using Neon:**
```bash
# Create database at neon.tech
# Get connection string
# Run same migrations
```

### 3. Deploy Redis

**Using Upstash:**
```bash
# Create Redis database at upstash.com
# Get REST URL and token
# Update REDIS_URL in backend env
```

### 4. Deploy Move Contracts

```bash
cd contracts

# Ensure you have deployment account funded
aptos init --network mainnet

# Compile
aptos move compile

# Deploy
aptos move publish \
  --named-addresses harvest=default,yuzu=0x...,joule=0x...,meridian=0x... \
  --assume-yes

# Verify deployment
aptos move view --function-id <deployed_address>::batch_claim::max_batch_size

# Note the deployed address for frontend config
echo "Deployed to: 0x..."
```

### 5. Deploy Backend

**Using Railway:**
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Create project
railway init

# Add environment variables via Railway dashboard

# Deploy
railway up

# Get URL (e.g., harvest-api.railway.app)
```

**Using Render:**
```yaml
# render.yaml
services:
  - type: web
    name: harvest-api
    env: node
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: REDIS_URL
        sync: false
```

**Using Fly.io:**
```bash
# Install flyctl
curl -L https://fly.io/install.sh | sh

# Launch
cd backend
fly launch

# Set secrets
fly secrets set DATABASE_URL=... REDIS_URL=...

# Deploy
fly deploy
```

### 6. Deploy Frontend

**Using Vercel:**
```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
cd frontend
vercel

# Set environment variables in Vercel dashboard
# Or via CLI:
vercel env add NEXT_PUBLIC_API_URL production
vercel env add NEXT_PUBLIC_PRIVY_APP_ID production
# ... add all env vars

# Deploy to production
vercel --prod
```

### 7. Configure Domain

**DNS Settings (example for Cloudflare):**
```
Type    Name       Content
A       @          76.76.21.21 (Vercel)
CNAME   www        cname.vercel-dns.com
CNAME   api        your-backend.railway.app
```

**Vercel Custom Domain:**
```bash
vercel domains add harvest.app
```

### 8. Set Up Monitoring

**Error Tracking (Sentry):**
```bash
# Frontend
npm install @sentry/nextjs

# Initialize in next.config.js
```

**Analytics (PostHog):**
```bash
npm install posthog-js

# Add to app layout
```

**Uptime Monitoring (BetterUptime/UptimeRobot):**
- Monitor: https://harvest.app
- Monitor: https://api.harvest.app/health
- Set alert thresholds

### 9. Security Checklist

```
[ ] HTTPS enabled on all domains
[ ] CORS configured correctly (only harvest.app allowed)
[ ] Rate limiting enabled on API
[ ] Database credentials not in code
[ ] API authentication for write operations
[ ] SQL injection prevention (parameterized queries)
[ ] XSS prevention (React's default escaping)
[ ] Environment variables not exposed in frontend bundle
```

### 10. Create Deployment Documentation

**docs/deployment.md**:
```markdown
# Harvest Deployment Guide

## Architecture
- Frontend: Vercel (harvest.app)
- Backend: Railway (api.harvest.app)
- Database: Supabase PostgreSQL
- Cache: Upstash Redis
- Contracts: Movement Mainnet

## Deployed Addresses
- Harvest Contract: 0x...
- Registry: 0x...

## URLs
- Production: https://harvest.app
- API: https://api.harvest.app
- Staging: https://staging.harvest.app

## Deployment Process

### Frontend
\`\`\`bash
cd frontend
vercel --prod
\`\`\`

### Backend
\`\`\`bash
cd backend
railway up
\`\`\`

### Database Migrations
\`\`\`bash
psql $DATABASE_URL < migrations/xxx.sql
\`\`\`

## Rollback
- Vercel: Use deployment history in dashboard
- Railway: `railway rollback`
- Database: Keep backup before migrations

## Monitoring
- Sentry: https://sentry.io/organizations/harvest/
- PostHog: https://app.posthog.com/project/xxx
- Uptime: https://betteruptime.com/team/xxx
```

### 11. Post-Deployment Verification

```bash
# Test frontend loads
curl -I https://harvest.app

# Test API health
curl https://api.harvest.app/health

# Test contract
aptos move view --function-id <address>::batch_claim::max_batch_size --url https://mainnet.movementnetwork.xyz/v1

# Test full flow
# 1. Connect wallet
# 2. View dashboard
# 3. Check rewards
# 4. Test claim (small amount)
```

## Deliverables
- [ ] Database deployed and migrated
- [ ] Redis deployed
- [ ] Move contracts deployed to mainnet
- [ ] Backend deployed and healthy
- [ ] Frontend deployed to custom domain
- [ ] HTTPS configured
- [ ] Monitoring set up
- [ ] `docs/deployment.md` created
- [ ] Full flow verified in production

## Verification
```bash
# All endpoints respond
curl https://harvest.app
curl https://api.harvest.app/health
curl https://api.harvest.app/api/leaderboard

# Contract deployed
aptos account list --account <harvest_address>
```

## Production Checklist
- [ ] All environment variables set
- [ ] Database migrations run
- [ ] Seed data loaded (airdrops)
- [ ] Telegram bot running
- [ ] Background jobs running
- [ ] Monitoring alerts configured
- [ ] Error tracking active
- [ ] SSL certificates valid
- [ ] DNS propagated

## Notes
- Keep deployment secrets secure
- Document any manual steps
- Set up alerts for errors and downtime
- Plan for scaling if needed
- Keep staging environment for testing
