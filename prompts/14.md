# Prompt 14: Implement Notifications System

## Objective
Implement a notification system for Telegram and Discord to alert users about new rewards, airdrops, and claim reminders.

## Pre-Flight Checklist
- [ ] Read `docs/issues/tooling/README.md` for any tooling issues
- [ ] Ensure Prompts 10-13 completed (backend with airdrops)
- [ ] Have Telegram Bot Token and Discord Webhook ready

## Context
The PRD specifies notifications as a P2 feature. Users should receive alerts for:
- New claimable rewards above threshold
- Airdrop eligibility and claim deadlines
- Scheduled reminders

## Tasks

### 1. Set Up Telegram Bot
Create a Telegram bot via @BotFather and get the token.

**backend/src/services/telegram-service.ts**:

```typescript
import TelegramBot from 'node-telegram-bot-api'
import { config } from '../config/env'
import { pool } from '../config/database'

const bot = config.telegram.botToken
  ? new TelegramBot(config.telegram.botToken, { polling: false })
  : null

class TelegramService {
  async sendMessage(chatId: string, message: string): Promise<boolean> {
    if (!bot) {
      console.warn('[Telegram] Bot not configured')
      return false
    }

    try {
      await bot.sendMessage(chatId, message, { parse_mode: 'HTML' })
      return true
    } catch (error) {
      console.error('[Telegram] Failed to send message:', error)
      return false
    }
  }

  async notifyNewRewards(
    chatId: string,
    rewards: { protocol: string; amount: string; valueUsd: number }[]
  ): Promise<boolean> {
    const totalValue = rewards.reduce((sum, r) => sum + r.valueUsd, 0)
    const rewardsList = rewards
      .map((r) => `‚Ä¢ <b>${r.protocol}</b>: ${r.amount} ($${r.valueUsd.toFixed(2)})`)
      .join('\n')

    const message = `
üåæ <b>New Rewards Available!</b>

${rewardsList}

<b>Total:</b> $${totalValue.toFixed(2)}

<a href="https://harvest.app/dashboard">Claim Now ‚Üí</a>
    `.trim()

    return this.sendMessage(chatId, message)
  }

  async notifyAirdropEligible(
    chatId: string,
    airdrop: { name: string; protocol: string; allocation: string; claimEnd?: string }
  ): Promise<boolean> {
    const deadline = airdrop.claimEnd
      ? `\n‚è∞ <b>Deadline:</b> ${new Date(airdrop.claimEnd).toLocaleDateString()}`
      : ''

    const message = `
üéÅ <b>You're Eligible for an Airdrop!</b>

<b>${airdrop.name}</b> (${airdrop.protocol})
üí∞ <b>Allocation:</b> ${airdrop.allocation}${deadline}

<a href="https://harvest.app/airdrops">Check Eligibility ‚Üí</a>
    `.trim()

    return this.sendMessage(chatId, message)
  }

  async notifyReminder(
    chatId: string,
    reminder: { name: string; protocol: string; type: string }
  ): Promise<boolean> {
    const message = `
‚è∞ <b>Reminder: ${reminder.name}</b>

Protocol: ${reminder.protocol}
${reminder.type === 'claim' ? 'üåæ Time to claim your rewards!' : 'üìÖ Check for updates!'}

<a href="https://harvest.app/airdrops">Open Harvest ‚Üí</a>
    `.trim()

    return this.sendMessage(chatId, message)
  }

  // Link Telegram to wallet address
  async linkWallet(telegramUserId: string, walletAddress: string): Promise<void> {
    await pool.query(`
      UPDATE users
      SET notification_preferences = jsonb_set(
        COALESCE(notification_preferences, '{}'),
        '{telegram}',
        $1
      )
      WHERE address = $2
    `, [JSON.stringify(telegramUserId), walletAddress.toLowerCase()])
  }
}

export const telegramService = new TelegramService()
```

### 2. Set Up Discord Webhooks
**backend/src/services/discord-service.ts**:

```typescript
import { config } from '../config/env'

class DiscordService {
  async sendWebhook(webhookUrl: string, embed: DiscordEmbed): Promise<boolean> {
    try {
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ embeds: [embed] }),
      })

      return response.ok
    } catch (error) {
      console.error('[Discord] Webhook failed:', error)
      return false
    }
  }

  async notifyNewRewards(
    webhookUrl: string,
    address: string,
    rewards: { protocol: string; amount: string; valueUsd: number }[]
  ): Promise<boolean> {
    const totalValue = rewards.reduce((sum, r) => sum + r.valueUsd, 0)
    const fields = rewards.map((r) => ({
      name: r.protocol,
      value: `${r.amount} ($${r.valueUsd.toFixed(2)})`,
      inline: true,
    }))

    const embed: DiscordEmbed = {
      title: 'üåæ New Rewards Available!',
      description: `Wallet: \`${address.slice(0, 6)}...${address.slice(-4)}\``,
      color: 0x22c55e, // Green
      fields: [
        ...fields,
        { name: 'Total', value: `$${totalValue.toFixed(2)}`, inline: false },
      ],
      footer: { text: 'Harvest - Movement Rewards Aggregator' },
      timestamp: new Date().toISOString(),
    }

    return this.sendWebhook(webhookUrl, embed)
  }

  async notifyAirdropEligible(
    webhookUrl: string,
    address: string,
    airdrop: { name: string; protocol: string; allocation: string }
  ): Promise<boolean> {
    const embed: DiscordEmbed = {
      title: 'üéÅ Airdrop Eligibility!',
      description: `Wallet \`${address.slice(0, 6)}...${address.slice(-4)}\` is eligible!`,
      color: 0xf59e0b, // Amber
      fields: [
        { name: 'Airdrop', value: airdrop.name, inline: true },
        { name: 'Protocol', value: airdrop.protocol, inline: true },
        { name: 'Allocation', value: airdrop.allocation, inline: true },
      ],
      footer: { text: 'Harvest - Movement Rewards Aggregator' },
      timestamp: new Date().toISOString(),
    }

    return this.sendWebhook(webhookUrl, embed)
  }
}

interface DiscordEmbed {
  title: string
  description: string
  color: number
  fields: { name: string; value: string; inline: boolean }[]
  footer: { text: string }
  timestamp: string
}

export const discordService = new DiscordService()
```

### 3. Create Notification Service
**backend/src/services/notification-service.ts**:

```typescript
import { pool } from '../config/database'
import { telegramService } from './telegram-service'
import { discordService } from './discord-service'

interface NotificationPayload {
  type: 'rewards' | 'airdrop' | 'reminder'
  data: any
}

class NotificationService {
  async notify(address: string, payload: NotificationPayload): Promise<void> {
    // Get user notification preferences
    const result = await pool.query(
      'SELECT notification_preferences FROM users WHERE address = $1',
      [address.toLowerCase()]
    )

    if (result.rows.length === 0) return

    const prefs = result.rows[0].notification_preferences || {}

    // Send to Telegram if configured
    if (prefs.telegram) {
      await this.sendTelegram(prefs.telegram, payload)
    }

    // Send to Discord if configured
    if (prefs.discord_webhook) {
      await this.sendDiscord(prefs.discord_webhook, address, payload)
    }
  }

  private async sendTelegram(chatId: string, payload: NotificationPayload): Promise<void> {
    switch (payload.type) {
      case 'rewards':
        await telegramService.notifyNewRewards(chatId, payload.data.rewards)
        break
      case 'airdrop':
        await telegramService.notifyAirdropEligible(chatId, payload.data)
        break
      case 'reminder':
        await telegramService.notifyReminder(chatId, payload.data)
        break
    }
  }

  private async sendDiscord(
    webhookUrl: string,
    address: string,
    payload: NotificationPayload
  ): Promise<void> {
    switch (payload.type) {
      case 'rewards':
        await discordService.notifyNewRewards(webhookUrl, address, payload.data.rewards)
        break
      case 'airdrop':
        await discordService.notifyAirdropEligible(webhookUrl, address, payload.data)
        break
    }
  }

  // Check and notify users with pending rewards
  async checkAndNotifyRewards(): Promise<void> {
    // Get users with notification preferences who haven't been notified recently
    const users = await pool.query(`
      SELECT address, notification_preferences
      FROM users
      WHERE notification_preferences IS NOT NULL
      AND notification_preferences != '{}'
    `)

    for (const user of users.rows) {
      // Check for new rewards (this would call protocol services)
      // If rewards exceed threshold, send notification
      // Track last notification time to avoid spam
    }
  }

  // Process pending reminders
  async processReminders(): Promise<void> {
    const result = await pool.query(`
      SELECT r.*, a.name, a.protocol, u.notification_preferences
      FROM airdrop_reminders r
      JOIN airdrops a ON r.airdrop_id = a.id
      JOIN users u ON r.user_address = u.address
      WHERE r.remind_at <= NOW()
      AND NOT r.notified
    `)

    for (const reminder of result.rows) {
      await this.notify(reminder.user_address, {
        type: 'reminder',
        data: {
          name: reminder.name,
          protocol: reminder.protocol,
          type: 'claim',
        },
      })

      // Mark as notified
      await pool.query(
        'UPDATE airdrop_reminders SET notified = TRUE WHERE id = $1',
        [reminder.id]
      )
    }
  }
}

export const notificationService = new NotificationService()
```

### 4. Add Notification Job
**backend/src/jobs/notification-worker.ts**:

```typescript
import { Worker } from 'bullmq'
import { redis } from '../config/redis'
import { notificationService } from '../services/notification-service'

export const notificationWorker = new Worker('notifications', async (job) => {
  console.log(`Processing notification job: ${job.name}`)

  switch (job.name) {
    case 'check-rewards':
      await notificationService.checkAndNotifyRewards()
      break
    case 'process-reminders':
      await notificationService.processReminders()
      break
  }
}, { connection: redis })
```

**backend/src/jobs/queue.ts** (add):

```typescript
export const notificationQueue = new Queue('notifications', { connection: redis })

// In initQueues():
// Check rewards every 30 minutes
await notificationQueue.add('check-rewards', {}, {
  repeat: { every: 30 * 60 * 1000 }
})

// Process reminders every 5 minutes
await notificationQueue.add('process-reminders', {}, {
  repeat: { every: 5 * 60 * 1000 }
})
```

### 5. Add Telegram Bot Commands
**backend/src/telegram-bot.ts**:

```typescript
import TelegramBot from 'node-telegram-bot-api'
import { config } from './config/env'
import { telegramService } from './services/telegram-service'

const bot = new TelegramBot(config.telegram.botToken, { polling: true })

// /start - Begin linking process
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id
  bot.sendMessage(chatId, `
Welcome to Harvest Bot! üåæ

To link your wallet and receive notifications:
1. Go to https://harvest.app/settings
2. Enter this code: <code>${chatId}</code>
3. Click "Link Telegram"

You'll then receive notifications for:
‚Ä¢ New claimable rewards
‚Ä¢ Airdrop eligibility
‚Ä¢ Claim reminders
  `, { parse_mode: 'HTML' })
})

// /link <address> - Link wallet (called via deep link)
bot.onText(/\/link (.+)/, async (msg, match) => {
  const chatId = msg.chat.id
  const address = match![1]

  await telegramService.linkWallet(chatId.toString(), address)
  bot.sendMessage(chatId, `‚úÖ Wallet linked successfully!\n\nYou'll now receive notifications for ${address.slice(0, 6)}...${address.slice(-4)}`)
})

// /status - Check connection status
bot.onText(/\/status/, (msg) => {
  const chatId = msg.chat.id
  bot.sendMessage(chatId, `Bot is running! Your chat ID: ${chatId}`)
})

export { bot as telegramBot }
```

### 6. Create Frontend Settings Page
**frontend/app/settings/page.tsx**:

```typescript
'use client'

import { useState } from 'react'
import { Card } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { useUserSettings } from '@/lib/hooks/use-user-settings'
import { MainLayout } from '@/components/layout/main-layout'

export default function SettingsPage() {
  const { settings, updateSettings, isUpdating } = useUserSettings()
  const [telegram, setTelegram] = useState(settings?.notification_preferences?.telegram || '')
  const [discordWebhook, setDiscordWebhook] = useState(
    settings?.notification_preferences?.discord_webhook || ''
  )

  const handleSave = () => {
    updateSettings({
      notification_preferences: {
        ...settings?.notification_preferences,
        telegram,
        discord_webhook: discordWebhook,
      },
    })
  }

  return (
    <MainLayout>
      <div className="space-y-6">
        <h1 className="text-2xl font-bold">Settings</h1>

        <Card className="p-6 space-y-4">
          <h2 className="text-lg font-semibold">Notifications</h2>

          <div className="space-y-2">
            <label className="text-sm font-medium">Telegram Chat ID</label>
            <p className="text-xs text-muted-foreground">
              Start a chat with @HarvestBot and use /start to get your chat ID
            </p>
            <Input
              value={telegram}
              onChange={(e) => setTelegram(e.target.value)}
              placeholder="123456789"
            />
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium">Discord Webhook URL</label>
            <p className="text-xs text-muted-foreground">
              Create a webhook in your Discord server settings
            </p>
            <Input
              value={discordWebhook}
              onChange={(e) => setDiscordWebhook(e.target.value)}
              placeholder="https://discord.com/api/webhooks/..."
            />
          </div>

          <Button onClick={handleSave} disabled={isUpdating}>
            {isUpdating ? 'Saving...' : 'Save Settings'}
          </Button>
        </Card>
      </div>
    </MainLayout>
  )
}
```

### 7. Update Environment Config
**backend/src/config/env.ts** (add):

```typescript
telegram: {
  botToken: process.env.TELEGRAM_BOT_TOKEN || '',
},
```

## Deliverables
- [ ] Created Telegram notification service
- [ ] Created Discord webhook service
- [ ] Created unified notification service
- [ ] Added notification background jobs
- [ ] Created Telegram bot with commands
- [ ] Created settings page in frontend
- [ ] Updated environment configuration

## Verification
```bash
# Set up bot token
export TELEGRAM_BOT_TOKEN=your_token

# Start backend
cd backend && npm run dev

# Test Telegram bot
# Send /start to your bot

# Test Discord webhook
curl -X POST "your_webhook_url" \
  -H "Content-Type: application/json" \
  -d '{"content": "Test message"}'
```

## Testing
- [ ] Telegram bot responds to /start
- [ ] Wallet linking works
- [ ] Discord webhook sends embeds
- [ ] Reminder notifications trigger on time
- [ ] Settings page saves preferences

## Notes
- Don't spam users - implement rate limiting
- Allow users to unsubscribe easily
- Log all notifications for debugging
- Handle API failures gracefully
